# DLT Pipeline definitions for TCGA project

resources:
  pipelines:
    # Main TCGA data ingestion and transformation pipeline
    tcga_etl_pipeline:
      name: "[${bundle.target}] TCGA ETL Pipeline"

      # Run as the deploying user to inherit their permissions
      run_as:
        user_name: "${var.user_name}"

      # Target schema for tables
      target: "${var.catalog_name}.${var.schema_name}"

      # Libraries (DLT Python files)
      libraries:
        - file:
            path: ../etl_pipelines/transformations/data_ingestion.py
        - file:
            path: ../etl_pipelines/transformations/transform.py

      # Cluster configuration (memory-optimized for ETL)
      clusters:
        - label: "default"
          autoscale:
            min_workers: 2
            max_workers: 8
            mode: ENHANCED
          node_type_id: "${var.etl_node_type}"  # r5.2xlarge: 8 vCPUs, 64 GB RAM
          spark_conf:
            spark.databricks.delta.optimizeWrite.enabled: "true"
            spark.databricks.delta.autoCompact.enabled: "true"
            spark.sql.adaptive.enabled: "true"
            spark.sql.adaptive.coalescePartitions.enabled: "true"
          # Enable Unity Catalog access
          data_security_mode: USER_ISOLATION

      # Pipeline configuration
      configuration:
        catalog: "${var.catalog_name}"
        schema: "${var.schema_name}"
        volume: "${var.volume_name}"
        pipelines.applyChangesPreviewEnabled: "true"

      # Development mode settings (controlled by target variable)
      development: ${var.pipeline_development_mode}

      # Continuous execution (disabled by default, enable for streaming)
      continuous: false

      # Channel (preview or current)
      channel: "CURRENT"

      # Edition (core, pro, advanced)
      edition: "ADVANCED"

      # Photon acceleration
      photon: true

      # Notifications (optional - uncomment and add your email)
      # notifications:
      #   - alerts:
      #       - "on-update-failure"
      #       - "on-update-fatal-failure"
      #     email_recipients:
      #       - "your-email@company.com"

      # Permissions (uncomment if groups exist)
      # permissions:
      #   - level: CAN_MANAGE
      #     group_name: "data-engineering"
      #   - level: CAN_VIEW
      #     group_name: "data-analysts"
